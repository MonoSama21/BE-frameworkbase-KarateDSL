name: ü•ã Karate API Tests - Manual & Scheduled

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Ingrese el tag del escenario Karate
        required: true
        type: string
        default: "@dailyTests"
      ambiente:
        description: Ambiente de ejecuci√≥n
        required: true
        type: choice
        options:
          - QA
          - DEV
        default: QA
      correo:
        description: Correo donde llegar√°n las notificaciones
        required: true
        type: string
        default: "2101010261@undc.edu.pe"
        
  schedule:
    # Lunes a Viernes 8 AM (Per√∫ UTC-5 = 13:00 UTC)
    - cron: "0 13 * * 1-5"
    # S√°bado y Domingo 10 AM (Per√∫ UTC-5 = 15:00 UTC)
    - cron: "0 15 * * 0,6"

jobs:
  Pruebas-Karate-API:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - uses: actions/checkout@v4

    - name: ‚òï Configurar JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: "temurin"
        java-version: "17"

    # =========================================================
    # üìå ASIGNAR TAG Y CORREO SEG√öN EL TIPO DE DISPARO
    # =========================================================
    - name: Detectar par√°metros para ejecuci√≥n autom√°tica o manual
      id: params
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          echo "correo=${{ github.event.inputs.correo }}" >> $GITHUB_OUTPUT
          echo "ambiente=${{ github.event.inputs.ambiente }}" >> $GITHUB_OUTPUT
        else
          # Lunes a Viernes
          if [[ $(date +%u) -lt 6 ]]; then
            echo "tag=@dailyTests" >> $GITHUB_OUTPUT
            echo "correo=2101010261@undc.edu.pe" >> $GITHUB_OUTPUT
            echo "ambiente=QA" >> $GITHUB_OUTPUT
          else
            # S√°bado y domingo
            echo "tag=@postLoginRolAuxiliar" >> $GITHUB_OUTPUT
            echo "correo=2101010261@undc.edu.pe" >> $GITHUB_OUTPUT
            echo "ambiente=QA" >> $GITHUB_OUTPUT
          fi
        fi

    # =========================================================
    # CORREO INICIAL (HTML)
    # =========================================================
    - name: Notificar inicio de ejecuci√≥n
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.MAIL_SERVER }}
        server_port: ${{ secrets.MAIL_PORT }}
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "üîµ Pruebas iniciadas - Karate API Testing"
        to: ${{ steps.params.outputs.correo }}
        from: ${{ secrets.MAIL_USERNAME }}
        html_body: |
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
          </head>
          <body style="margin: 0; padding: 0; background-color: #f4f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f7fa; padding: 40px 0;">
              <tr>
                <td align="center">
                  <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;">
                    <!-- Header -->
                    <tr>
                      <td style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 40px; text-align: center;">
                        <img src="https://res.cloudinary.com/dvrsdqsl1/image/upload/v1764399269/Blue_Minimalist_Technology_Cube_Logo_1_x445ab.png" width="120" style="margin-bottom: 15px;">
                        <h1 style="color: #ffffff; margin: 0; font-size: 28px; font-weight: 600;">üöÄ Pruebas Iniciadas</h1>
                        <p style="color: #e0e7ff; margin: 10px 0 0 0; font-size: 14px;">Sistema de Testing Continuo - SIASIS</p>
                      </td>
                    </tr>
                    <!-- Content -->
                    <tr>
                      <td style="padding: 40px;">
                        <div style="background-color: #f8f9ff; border-left: 4px solid #667eea; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                          <p style="margin: 0; font-size: 16px; color: #334155;">‚ö° Las pruebas automatizadas Karate DSL han comenzado su ejecuci√≥n.</p>
                        </div>
                        
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 30px;">
                          <tr>
                            <td style="padding: 15px 0; border-bottom: 1px solid #e2e8f0;">
                              <span style="color: #64748b; font-size: 14px; font-weight: 500;">üìã Tag Ejecutado</span><br>
                              <span style="color: #667eea; font-size: 18px; font-weight: 600; margin-top: 5px; display: inline-block;">${{ steps.params.outputs.tag }}</span>
                            </td>
                          </tr>
                          <tr>
                            <td style="padding: 15px 0; border-bottom: 1px solid #e2e8f0;">
                              <span style="color: #64748b; font-size: 14px; font-weight: 500;">üåç Ambiente</span><br>
                              <span style="color: #10b981; font-size: 18px; font-weight: 600; margin-top: 5px; display: inline-block; text-transform: uppercase;">${{ steps.params.outputs.ambiente }}</span>
                            </td>
                          </tr>
                          <tr>
                            <td style="padding: 15px 0; border-bottom: 1px solid #e2e8f0;">
                              <span style="color: #64748b; font-size: 14px; font-weight: 500;">‚è±Ô∏è Hora de Inicio</span><br>
                              <span style="color: #1e293b; font-size: 16px; margin-top: 5px; display: inline-block;">${{ github.event.repository.updated_at }}</span>
                            </td>
                          </tr>
                          <tr>
                            <td style="padding: 15px 0;">
                              <span style="color: #64748b; font-size: 14px; font-weight: 500;">üîó Build Number</span><br>
                              <span style="color: #1e293b; font-size: 16px; margin-top: 5px; display: inline-block;">#${{ github.run_number }}</span>
                            </td>
                          </tr>
                        </table>
                        
                        <div style="text-align: center; margin: 30px 0;">
                          <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; padding: 14px 32px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 600; font-size: 15px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                            üîç Ver Ejecuci√≥n en Tiempo Real
                          </a>
                        </div>
                      </td>
                    </tr>
                    <!-- Footer -->
                    <tr>
                      <td style="background-color: #f8fafc; padding: 25px 40px; border-top: 1px solid #e2e8f0;">
                        <p style="color: #64748b; font-size: 13px; margin: 0; line-height: 1.6;">
                          <strong style="color: #1e293b;">QA Automation SSr Yrvin Pachas</strong><br>
                          Testing Continuo - ZeusTesting<br>
                          ü§ñ Mensaje autom√°tico del sistema de CI/CD
                        </p>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </body>
          </html>

    - name: üì¶ Instalar dependencias Maven
      run: mvn clean install -DskipTests

    - name: üß™ Ejecutar pruebas Karate con tag
      id: run_tests
      run: |
        mvn test -Dkarate.options="--tags ${{ steps.params.outputs.tag }}" -Dkarate.env=${{ steps.params.outputs.ambiente }} || echo "resultado=$?" >> $GITHUB_OUTPUT
        echo "resultado=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: üìÇ List target directory
      run: ls -R target

    # =========================================================
    # üìä EXTRAER RESULTADOS DEL REPORTE JSON DE KARATE
    # =========================================================
    - name: Extraer resultados de Karate
      if: always()
      id: test_results
      run: |
        REPORT_DIR="target/karate-reports"
        
        if [ -d "$REPORT_DIR" ]; then
          echo "üìã Generando estad√≠sticas desde reportes Karate..."
          
          # Archivos temporales
          > /tmp/scenarios_list.txt
          > /tmp/scenarios_html.txt
          
          # Buscar el archivo JSON de Karate (fuente principal)
          JSON_FILE=$(find target -name "karate-summary-json.txt" -o -name "karate-summary.json" | head -n 1)
          
          if [ -n "$JSON_FILE" ] && [ -f "$JSON_FILE" ]; then
            echo "üìÑ Usando archivo JSON de Karate: $JSON_FILE"
            
            # Extraer estad√≠sticas del JSON (OJO: Karate usa scenariosfailed en min√∫sculas)
            PASSED=$(jq -r '.scenariosPassed // 0' "$JSON_FILE" 2>/dev/null || echo "0")
            FAILED=$(jq -r '.scenariosfailed // 0' "$JSON_FILE" 2>/dev/null || echo "0")
            SKIPPED=0
            TOTAL=$((PASSED + FAILED + SKIPPED))
            
            echo "‚úÖ PASSED: $PASSED"
            echo "‚ùå FAILED: $FAILED"
            echo "‚è≠Ô∏è SKIPPED: $SKIPPED"
            echo "üìù TOTAL: $TOTAL"
            
            # Extraer detalles de features desde el JSON
            echo "üìù Extrayendo detalles desde featureSummary..."
            
            # Procesar cada feature en el resumen
            jq -r '.featureSummary[] | "\(.name)|\(.failed)|\(.passedCount)|\(.failedCount)"' "$JSON_FILE" 2>/dev/null | while IFS='|' read -r name failed passed_count failed_count; do
              if [ -n "$name" ] && [ "$name" != "null" ]; then
                # Si el feature pas√≥, agregar sus escenarios como passed
                if [ "$failed" = "false" ]; then
                  for i in $(seq 1 $passed_count); do
                    scenario_name="$name"
                    [ "$passed_count" -gt 1 ] && scenario_name="$name [caso $i]"
                    echo "- ‚úÖ **PASSED**: $scenario_name" >> /tmp/scenarios_list.txt
                    echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:green; font-weight: bold;'>‚úÖ PASSED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>$scenario_name</td></tr>" >> /tmp/scenarios_html.txt
                  done
                fi
                
                # Si el feature fall√≥, agregar sus escenarios como failed
                if [ "$failed" = "true" ]; then
                  for i in $(seq 1 $failed_count); do
                    scenario_name="$name"
                    [ "$failed_count" -gt 1 ] && scenario_name="$name [caso $i]"
                    echo "- ‚ùå **FAILED**: $scenario_name" >> /tmp/scenarios_list.txt
                    echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:red; font-weight: bold;'>‚ùå FAILED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>$scenario_name</td></tr>" >> /tmp/scenarios_html.txt
                  done
                  
                  # Tambi√©n agregar los passed de este feature si los hay
                  if [ "$passed_count" -gt 0 ]; then
                    for i in $(seq 1 $passed_count); do
                      scenario_name="$name"
                      [ "$passed_count" -gt 1 ] && scenario_name="$name [caso $i]"
                      echo "- ‚úÖ **PASSED**: $scenario_name" >> /tmp/scenarios_list.txt
                      echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:green; font-weight: bold;'>‚úÖ PASSED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>$scenario_name</td></tr>" >> /tmp/scenarios_html.txt
                    done
                  fi
                fi
              fi
            done
            
          else
            echo "‚ö†Ô∏è No se encontr√≥ archivo JSON de Karate"
            PASSED=0
            FAILED=0
            SKIPPED=0
            TOTAL=0
          fi
          
          # Si a√∫n no hay escenarios en los archivos temporales, usar fallback
          if [ ! -s /tmp/scenarios_html.txt ]; then
            echo "üìä Generando resumen basado en estad√≠sticas globales (fallback)..."
            
            if [ "$PASSED" -gt 0 ]; then
              for i in $(seq 1 $PASSED); do
                echo "- ‚úÖ **PASSED**: Escenario #$i" >> /tmp/scenarios_list.txt
                echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:green; font-weight: bold;'>‚úÖ PASSED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>Escenario #$i</td></tr>" >> /tmp/scenarios_html.txt
              done
            fi
            
            if [ "$FAILED" -gt 0 ]; then
              for i in $(seq 1 $FAILED); do
                echo "- ‚ùå **FAILED**: Escenario #$i" >> /tmp/scenarios_list.txt
                echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:red; font-weight: bold;'>‚ùå FAILED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>Escenario #$i</td></tr>" >> /tmp/scenarios_html.txt
              done
            fi
            
            if [ "$TOTAL" -eq 0 ]; then
              echo "<tr><td colspan='2' style='border: 1px solid #ddd; padding: 10px; text-align: center; color: orange;'>‚ÑπÔ∏è Ver detalles completos en el reporte HTML</td></tr>" > /tmp/scenarios_html.txt
              echo "- ‚ÑπÔ∏è Ver detalles completos en el reporte HTML" > /tmp/scenarios_list.txt
            fi
          fi
          
          # Crear tabla de resumen HTML
          TABLE="<table style='border-collapse: collapse; width: 100%; margin: 20px 0;'>"
          TABLE="$TABLE<tr style='background-color: #f2f2f2;'>"
          TABLE="$TABLE<th style='border: 1px solid #ddd; padding: 12px;'>Total</th>"
          TABLE="$TABLE<th style='border: 1px solid #ddd; padding: 12px; color: green;'>‚úÖ Passed</th>"
          TABLE="$TABLE<th style='border: 1px solid #ddd; padding: 12px; color: red;'>‚ùå Failed</th>"
          TABLE="$TABLE<th style='border: 1px solid #ddd; padding: 12px; color: gray;'>‚è≠Ô∏è Skipped</th>"
          TABLE="$TABLE</tr><tr>"
          TABLE="$TABLE<td style='border: 1px solid #ddd; padding: 12px; text-align: center;'><strong>$TOTAL</strong></td>"
          TABLE="$TABLE<td style='border: 1px solid #ddd; padding: 12px; text-align: center;'><strong>$PASSED</strong></td>"
          TABLE="$TABLE<td style='border: 1px solid #ddd; padding: 12px; text-align: center;'><strong>$FAILED</strong></td>"
          TABLE="$TABLE<td style='border: 1px solid #ddd; padding: 12px; text-align: center;'><strong>$SKIPPED</strong></td>"
          TABLE="$TABLE</tr></table>"
          
          # Tabla de escenarios
          SCENARIOS_TABLE="<h3 style='color:#333; margin-top: 20px;'>üìã Escenarios Ejecutados:</h3>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE<table style='border-collapse: collapse; width: 100%; margin: 20px 0;'>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE<tr style='background-color: #f2f2f2;'>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE<th style='border: 1px solid #ddd; padding: 12px; width: 150px;'>Estado</th>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE<th style='border: 1px solid #ddd; padding: 12px;'>Escenario</th>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE</tr>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE$(cat /tmp/scenarios_html.txt)"
          SCENARIOS_TABLE="$SCENARIOS_TABLE</table>"
          
          # Guardar en outputs
          echo "table_html<<EOF" >> $GITHUB_OUTPUT
          echo "$TABLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "scenarios_table<<EOF" >> $GITHUB_OUTPUT
          echo "$SCENARIOS_TABLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          
          # GitHub Summary
          echo "## üìä Resultados de las Pruebas Karate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| M√©trica | Cantidad |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| üìù Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚è≠Ô∏è Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Escenarios Ejecutados:" >> $GITHUB_STEP_SUMMARY
          cat /tmp/scenarios_list.txt >> $GITHUB_STEP_SUMMARY || true
        else
          echo "‚ö†Ô∏è No se encontr√≥ directorio de reportes Karate"
          echo "table_html=<p style='color: orange;'>‚ö†Ô∏è No se encontraron reportes</p>" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è No se pudo generar el resumen de resultados" >> $GITHUB_STEP_SUMMARY
        fi

    # Subir artefacto completo
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: karate-report
        path: target/karate-reports/
        retention-days: 14

    # =========================================================
    # üåê DESPLEGAR REPORTE EN GITHUB PAGES
    # =========================================================
    - name: Preparar GitHub Pages con historial
      if: always()
      run: |
        mkdir -p gh-pages/reports/${{ github.run_number }}
        
        # Copiar reportes de Karate
        if [ -d "target/karate-reports" ]; then
          cp -r target/karate-reports/* gh-pages/reports/${{ github.run_number }}/
          echo "‚úÖ Reportes de Karate copiados"
        fi
        
        # Crear metadata
        cat > gh-pages/reports/${{ github.run_number }}/metadata.json << EOF
        {
          "run_number": "${{ github.run_number }}",
          "tag": "${{ steps.params.outputs.tag }}",
          "ambiente": "${{ steps.params.outputs.ambiente }}",
          "fecha": "$(TZ=America/Lima date '+%Y-%m-%d %H:%M:%S')",
          "timezone": "America/Lima"
        }
        EOF
        
        # Copiar test-launcher como index
        if [ -f "test-launcher.html" ]; then
          cp test-launcher.html gh-pages/index.html
          echo "‚úÖ Plataforma configurada como p√°gina principal"
        fi
        
        # üî• DESCARGAR HISTORIAL PREVIO
        HISTORY_FILE="gh-pages/history.json"
        PAGES_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/history.json"
        
        echo "üì• Descargando historial previo..."
        if curl -fsSL "$PAGES_URL" -o "$HISTORY_FILE" 2>/dev/null; then
          echo "‚úÖ Historial descargado"
        else
          echo "[]" > "$HISTORY_FILE"
        fi
        
        # Extraer datos
        PASSED="${{ steps.test_results.outputs.passed }}"
        FAILED="${{ steps.test_results.outputs.failed }}"
        SKIPPED="${{ steps.test_results.outputs.skipped }}"
        TOTAL="${{ steps.test_results.outputs.total }}"
        
        # Crear objeto JSON
        EXECUTION_DATA=$(cat <<EOF
        {
          "id": "${{ github.run_id }}",
          "runNumber": ${{ github.run_number }},
          "tag": "${{ steps.params.outputs.tag }}",
          "ambiente": "${{ steps.params.outputs.ambiente }}",
          "date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "dateFormatted": "$(TZ=America/Lima date +"%d/%m/%Y %H:%M")",
          "total": ${TOTAL:-0},
          "passed": ${PASSED:-0},
          "failed": ${FAILED:-0},
          "skipped": ${SKIPPED:-0},
          "status": "${{ steps.run_tests.outputs.resultado == '0' && 'passed' || 'failed' }}",
          "branch": "${{ github.ref_name }}",
          "commit": "${{ github.sha }}",
          "commitShort": "${GITHUB_SHA:0:7}",
          "actor": "${{ github.actor }}",
          "reportUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}/karate-summary.html",
          "actionsUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        }
        EOF
        )
        
        # Agregar al historial (√∫ltimas 50)
        jq --argjson new "$EXECUTION_DATA" '. = [$new] + . | .[0:50]' "$HISTORY_FILE" > "${HISTORY_FILE}.tmp"
        mv "${HISTORY_FILE}.tmp" "$HISTORY_FILE"
        
        echo "‚úÖ Historial actualizado"

    - name: Deploy to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./gh-pages
        publish_branch: gh-pages
        keep_files: true
        force_orphan: false

    # =========================================================
    # üìß CORREO FINAL CON TABLA DE RESULTADOS
    # =========================================================
    - name: Notificar fin de ejecuci√≥n con resultados
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.MAIL_SERVER }}
        server_port: ${{ secrets.MAIL_PORT }}
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "üü¢ Pruebas finalizadas - Karate API Testing"
        to: ${{ steps.params.outputs.correo }}
        from: ${{ secrets.MAIL_USERNAME }}
        html_body: |
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
          </head>
          <body style="margin: 0; padding: 0; background-color: #f4f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f7fa; padding: 40px 0;">
              <tr>
                <td align="center">
                  <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;">
                    <!-- Header -->
                    <tr>
                      <td style="background: ${{ steps.run_tests.outputs.resultado == '0' && 'linear-gradient(135deg, #10b981 0%, #059669 100%)' || 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' }}; padding: 30px 40px; text-align: center;">
                        <img src="https://res.cloudinary.com/dvrsdqsl1/image/upload/v1764399269/Blue_Minimalist_Technology_Cube_Logo_1_x445ab.png" width="120" style="margin-bottom: 15px;">
                        <h1 style="color: #ffffff; margin: 0; font-size: 28px; font-weight: 600;">
                          ${{ steps.run_tests.outputs.resultado == '0' && '‚úÖ Pruebas Exitosas' || '‚ùå Pruebas con Fallos' }}
                        </h1>
                        <p style="color: #e0e7ff; margin: 10px 0 0 0; font-size: 14px;">Reporte de Ejecuci√≥n - SIASIS Testing</p>
                      </td>
                    </tr>
                    <!-- Status Badge -->
                    <tr>
                      <td style="padding: 30px 40px 20px;">
                        <div style="text-align: center; margin-bottom: 30px;">
                          <span style="background-color: ${{ steps.run_tests.outputs.resultado == '0' && '#dcfce7' || '#fee2e2' }}; color: ${{ steps.run_tests.outputs.resultado == '0' && '#166534' || '#991b1b' }}; padding: 12px 24px; border-radius: 20px; font-weight: 600; font-size: 16px; display: inline-block;">
                            Estado: ${{ steps.run_tests.outputs.resultado == '0' && 'PASSED ‚úì' || 'FAILED ‚úó' }}
                          </span>
                        </div>
                        
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 25px;">
                          <tr>
                            <td style="padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                              <span style="color: #64748b; font-size: 14px;">üìã Tag Ejecutado</span><br>
                              <span style="color: #1e293b; font-size: 16px; font-weight: 600; margin-top: 5px; display: inline-block;">${{ steps.params.outputs.tag }}</span>
                            </td>
                          </tr>
                          <tr>
                            <td style="padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                              <span style="color: #64748b; font-size: 14px;">üåç Ambiente</span><br>
                              <span style="color: #10b981; font-size: 16px; font-weight: 600; margin-top: 5px; display: inline-block; text-transform: uppercase;">${{ steps.params.outputs.ambiente }}</span>
                            </td>
                          </tr>
                        </table>
                      </td>
                    </tr>
                    <!-- Results Table -->
                    <tr>
                      <td style="padding: 0 40px 20px;">
                        <h3 style="color: #1e293b; font-size: 18px; margin: 0 0 15px 0; font-weight: 600;">üìä Resumen de Resultados</h3>
                        ${{ steps.test_results.outputs.table_html }}
                      </td>
                    </tr>
                    <!-- Scenarios -->
                    <tr>
                      <td style="padding: 0 40px 30px;">
                        ${{ steps.test_results.outputs.scenarios_table }}
                      </td>
                    </tr>
                    <!-- Action Buttons -->
                    <tr>
                      <td style="padding: 0 40px 30px;">
                        <div style="background-color: #f8fafc; border-radius: 8px; padding: 25px; text-align: center;">
                          <p style="color: #64748b; font-size: 14px; margin: 0 0 20px 0; font-weight: 500;">üìÑ Recursos Disponibles</p>
                          
                          <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" 
                             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; padding: 12px 28px; text-decoration: none; border-radius: 8px; display: inline-block; margin: 5px; font-weight: 600; font-size: 14px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                            üöÄ Plataforma de Testing
                          </a>
                          
                          <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}/karate-summary.html" 
                             style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: #ffffff; padding: 12px 28px; text-decoration: none; border-radius: 8px; display: inline-block; margin: 5px; font-weight: 600; font-size: 14px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
                            üìä Ver Reporte HTML
                          </a>
                          
                          <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                             style="background-color: #64748b; color: #ffffff; padding: 12px 28px; text-decoration: none; border-radius: 8px; display: inline-block; margin: 5px; font-weight: 600; font-size: 14px;">
                            üîó Ver en GitHub Actions
                          </a>
                          
                          <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" 
                             style="background-color: #8b5cf6; color: #ffffff; padding: 12px 28px; text-decoration: none; border-radius: 8px; display: inline-block; margin: 5px; font-weight: 600; font-size: 14px;">
                            üì¶ Descargar Reportes
                          </a>
                        </div>
                      </td>
                    </tr>
                    <!-- Footer -->
                    <tr>
                      <td style="background-color: #f8fafc; padding: 25px 40px; border-top: 1px solid #e2e8f0;">
                        <table width="100%" cellpadding="0" cellspacing="0">
                          <tr>
                            <td>
                              <p style="color: #64748b; font-size: 13px; margin: 0; line-height: 1.6;">
                                <strong style="color: #1e293b;">QA Automation SSr Yrvin Pachas</strong><br>
                                Testing Continuo - ZeusTesting<br>
                                Build #${{ github.run_number }} ‚Ä¢ Branch: ${{ github.ref_name }}
                              </p>
                            </td>
                            <td align="right">
                              <span style="color: #94a3b8; font-size: 24px;">ü•ã</span>
                            </td>
                          </tr>
                        </table>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </body>
          </html>
